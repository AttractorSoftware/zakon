{% extends "document/base.html" %}
<!DOCTYPE html>


{% block title %} {{ document.name }} {% endblock %}
{% block content %}
    {% load staticfiles %}


    <form id="modal" class="modal hide" action="{% url 'document:wrap_text' %}" method="post">
        {% csrf_token %}
        <div class="modal-header">
            <h2>Lorem Ipsum</h2>
        </div>
        <div class="modal-body">
            <div class="form-inline">
                <input type="hidden" name="document_id" value="{{ document_id }}"/>
                <input type="hidden" name="article_item_id" id="article_item_id" value=""/>
                <input type="hidden" name="start_position" value="" id="start_position"/>
                <input type="hidden" name="length" value="" id="length"/>
                <input type="text" name="reference_url" id="reference_url" value=""/>
                <button type="submit" data-dismiss="modal" aria-hidden="true"
                        onClick="sendSelectionTextPositions();return false;">Отправить
                </button>
            </div>
            <div class="documents-view">

            </div>
        </div>
    </form>


    <a href="#modal" role="button" class="btn hide" id='ShowModalWindow' data-toggle="modal"
       style="position: fixed; left: 40px;">Click Me</a>
    <div id="list" style="width: 940px; background: #ffc; padding: 0 15px;">

    <p style="margin-top: 20px; margin-left: 500px"> {{ document.uploaded_date }} </p>

    <div style="margin-top: 100px; padding-bottom: 50px;" document_id="{{ document_id }}">
        {% autoescape off %}
            {{ content }}
        {% endautoescape %}
    </div>
    <script type="text/javascript">

        var selected;
        var selRange;
        $('document').ready(function () {


            $('#ShowModalWindow').click(function () {
                $('#modal').modal();
                getDocuments();

                showCaretPos();
                $(".documents-view a").attr('onclick', 'return false');
            })

            $('#list').mouseup(function () {
                showClickMeButton();
            });
            $('#list').dblclick(function () {
                showClickMeButton();
            });

            $('#list').click(function () {
                if (selectedText().length <= 0 && !$('#ShowModalWindow').hasClass('hide')) {
                    $('#ShowModalWindow').addClass('hide');
                }
            });

            function showClickMeButton() {
                if (selectedText().length > 0) {
                    $('#ShowModalWindow').removeClass('hide');
                    selected = window.getSelection();
                    selRange = selected.getRangeAt(0);
                }

            }

            function selectedText() {
                if (window.getSelection)
                    txt = window.getSelection().toString();
                else if (document.getSelection)
                    txt = document.getSelection();
                else if (document.selection)
                    txt = document.selection.createRange().text;
                return txt;

            }


        });
        {#----------------------------------------------------------------------------------#}
        function getCaretCharacterOffsetWithin(element) {
            var caretOffset = 0;
            var doc = element.ownerDocument || element.document;
            var win = doc.defaultView || doc.parentWindow;
            var sel;
            if (typeof win.getSelection != "undefined") {
                var range = win.getSelection().getRangeAt(0);
                var preCaretRange = range.cloneRange();
                preCaretRange.selectNodeContents(element);
                preCaretRange.setEnd(range.endContainer, range.endOffset);
                caretOffset = preCaretRange.toString().length;
            } else if ((sel = doc.selection) && sel.type != "Control") {
                var textRange = sel.createRange();
                var preCaretTextRange = doc.body.createTextRange();
                preCaretTextRange.moveToElementText(element);
                preCaretTextRange.setEndPoint("EndToEnd", textRange);
                caretOffset = preCaretTextRange.text.length;
            }
            return caretOffset;
        }

        function showCaretPos() {
            var el = document.getElementById(selected.extentNode.parentElement.id);
            $('#length').val(selRange.endOffset - selRange.startOffset);
            $('#start_position').val(getCaretCharacterOffsetWithin(el)-$('#length').val()-2);


            return getCaretCharacterOffsetWithin(el);

        }



        {#------------------------------------------------------------------------------------#}

        function sendSelectionTextPositions() {

            $('#ShowModalWindow').addClass('hide');
            $('#article_item_id').val(selected.extentNode.parentElement.id);
            $('#modal').submit();
            {#            window.location.reload();#}
        }

        function getDocuments() {
            $(".documents-view").load("/ ol", function () {
                $(".documents-view ol a").attr('onclick', 'return false');
                $('.documents-view a').click(function () {

                    if (jQuery(this).attr('href') !== undefined) {

                        console.log(jQuery(this).attr('href'))
                        fullDocumentView(jQuery(this).attr('href'));
                    }
                })
            });
        }

        function fullDocumentView(id) {
            $(".documents-view").load(id + " #contents");
        }

        function handler(event) {
            var $target = $(event.target);
            if ($target.is("a")) {
                $target.children().toggle();
            }
        }
        $(".documents-view").click(handler).find("ul").hide();

        function sendAjaxQuery() {
            var data = { choice: 'test-ajax'};
            var args = { type: "POST",
                url: "/wrap_text/",
                data: data
            };
            $.ajax(args);
        }


    </script>
{% endblock %}
{% block footer %} {% endblock %}
