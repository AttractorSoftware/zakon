import unittest
from References.models import Reference
from References.update_content import XMLReferenceAdder
from References.views import ReferenceAdder
from document.models import Document

class AddReferenceTests(unittest.TestCase):

    def test_update_content_of_source_document(self):
        ref = Reference()
        ref.source_document = Document(1)
        ref.source_element = u'#article_1'
        ref.target_document = Document(2)
        ref.target_element = u'#article_2'
        content = u'<document><description><name>&#1047;&#1040;&#1050;&#1054;&#1053; &#1050;&#1067;&#1056;&#1043;&#1067;&#1047;&#1057;&#1050;&#1054;&#1049; &#1056;&#1045;&#1057;&#1055;&#1059;&#1041;&#1051;&#1048;&#1050;&#1048;2\n\n&#1054; &#1075;&#1086;&#1089;&#1091;&#1076;&#1072;&#1088;&#1089;&#1090;&#1074;&#1077;&#1085;&#1085;&#1086;&#1081; &#1088;&#1077;&#1075;&#1080;&#1089;&#1090;&#1088;&#1072;&#1094;&#1080;&#1080; &#1102;&#1088;&#1080;&#1076;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1093;\n\n&#1083;&#1080;&#1094;, &#1092;&#1080;&#1083;&#1080;&#1072;&#1083;&#1086;&#1074; (&#1087;&#1088;&#1077;&#1076;&#1089;&#1090;&#1072;&#1074;&#1080;&#1090;&#1077;&#1083;&#1100;&#1089;&#1090;&#1074;)</name><place>&#1075;.&#1041;&#1080;&#1096;&#1082;&#1077;&#1082;\n\n&#1086;&#1090; 20 &#1092;&#1077;&#1074;&#1088;&#1072;&#1083;&#1103; 2009 &#1075;&#1086;&#1076;&#1072; N 57</place><revisions>(&#1042; &#1088;&#1077;&#1076;&#1072;&#1082;&#1094;&#1080;&#1080; &#1047;&#1072;&#1082;&#1086;&#1085;&#1086;&#1074; &#1050;&#1056; &#1086;&#1090; 15 &#1080;&#1102;&#1083;&#1103; 2009 &#1075;&#1086;&#1076;&#1072; N 207,\n\n18 &#1076;&#1077;&#1082;&#1072;&#1073;&#1088;&#1103; 2009 &#1075;&#1086;&#1076;&#1072; N 313, 21 &#1076;&#1077;&#1082;&#1072;&#1073;&#1088;&#1103; 2011 &#1075;&#1086;&#1076;&#1072; N 241,\n\n13 &#1072;&#1087;&#1088;&#1077;&#1083;&#1103; 2012 &#1075;&#1086;&#1076;&#1072; N 35, 13 &#1076;&#1077;&#1082;&#1072;&#1073;&#1088;&#1103; 2012 &#1075;&#1086;&#1076;&#1072; N 199)</revisions></description><article id="article_1" number="1" name="&#1057;&#1090;&#1072;&#1090;&#1100;&#1103; 1. &#1054;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1084;&#1099;&#1077; &#1085;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1084; &#1047;&#1072;&#1082;&#1086;&#1085;&#1086;&#1084;" level="article"><item number="1" id="article1_item_1" level="article1_item">&#1053;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1081; &#1047;&#1072;&#1082;&#1086;&#1085; &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1090; &#1086;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1074;&#1086;&#1079;&#1085;&#1080;&#1082;&#1072;</item></article></document>'
        ref.source_document.uploaded_date = '2013-11-26 15:05:07.613518+00:00'
        expected_xml = '<document>\n  <description>\n    <name>&#1047;&#1040;&#1050;&#1054;&#1053; &#1050;&#1067;&#1056;&#1043;&#1067;&#1047;&#1057;&#1050;&#1054;&#1049; &#1056;&#1045;&#1057;&#1055;&#1059;&#1041;&#1051;&#1048;&#1050;&#1048;2\n\n&#1054; &#1075;&#1086;&#1089;&#1091;&#1076;&#1072;&#1088;&#1089;&#1090;&#1074;&#1077;&#1085;&#1085;&#1086;&#1081; &#1088;&#1077;&#1075;&#1080;&#1089;&#1090;&#1088;&#1072;&#1094;&#1080;&#1080; &#1102;&#1088;&#1080;&#1076;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1093;\n\n&#1083;&#1080;&#1094;, &#1092;&#1080;&#1083;&#1080;&#1072;&#1083;&#1086;&#1074; (&#1087;&#1088;&#1077;&#1076;&#1089;&#1090;&#1072;&#1074;&#1080;&#1090;&#1077;&#1083;&#1100;&#1089;&#1090;&#1074;)</name>\n    <place>&#1075;.&#1041;&#1080;&#1096;&#1082;&#1077;&#1082;\n\n&#1086;&#1090; 20 &#1092;&#1077;&#1074;&#1088;&#1072;&#1083;&#1103; 2009 &#1075;&#1086;&#1076;&#1072; N 57</place>\n    <revisions>(&#1042; &#1088;&#1077;&#1076;&#1072;&#1082;&#1094;&#1080;&#1080; &#1047;&#1072;&#1082;&#1086;&#1085;&#1086;&#1074; &#1050;&#1056; &#1086;&#1090; 15 &#1080;&#1102;&#1083;&#1103; 2009 &#1075;&#1086;&#1076;&#1072; N 207,\n\n18 &#1076;&#1077;&#1082;&#1072;&#1073;&#1088;&#1103; 2009 &#1075;&#1086;&#1076;&#1072; N 313, 21 &#1076;&#1077;&#1082;&#1072;&#1073;&#1088;&#1103; 2011 &#1075;&#1086;&#1076;&#1072; N 241,\n\n13 &#1072;&#1087;&#1088;&#1077;&#1083;&#1103; 2012 &#1075;&#1086;&#1076;&#1072; N 35, 13 &#1076;&#1077;&#1082;&#1072;&#1073;&#1088;&#1103; 2012 &#1075;&#1086;&#1076;&#1072; N 199)</revisions>\n  </description>\n  <article id="article_1" number="1" name="&#1057;&#1090;&#1072;&#1090;&#1100;&#1103; 1. &#1054;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1084;&#1099;&#1077; &#1085;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1084; &#1047;&#1072;&#1082;&#1086;&#1085;&#1086;&#1084;" level="article">\n    <item number="1" id="article1_item_1" level="article1_item">&#1053;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1081; &#1047;&#1072;&#1082;&#1086;&#1085; &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1090; &#1086;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1074;&#1086;&#1079;&#1085;&#1080;&#1082;&#1072;</item>\n    <references>\n      <reference doc_id="2" element="article_2"/>\n    </references>\n  </article>\n</document>\n'
        self.assertEqual(expected_xml, XMLReferenceAdder(ref).update_source_document_content())

    def test_update_content_of_target_document(self):
        ref = Reference()
        target_document_content = u'<document><description><name>&#1047;&#1040;&#1050;&#1054;&#1053; &#1050;&#1067;&#1056;&#1043;&#1067;&#1047;&#1057;&#1050;&#1054;&#1049; &#1056;&#1045;&#1057;&#1055;&#1059;&#1041;&#1051;&#1048;&#1050;&#1048;2\n\n&#1054; &#1075;&#1086;&#1089;&#1091;&#1076;&#1072;&#1088;&#1089;&#1090;&#1074;&#1077;&#1085;&#1085;&#1086;&#1081; &#1088;&#1077;&#1075;&#1080;&#1089;&#1090;&#1088;&#1072;&#1094;&#1080;&#1080; &#1102;&#1088;&#1080;&#1076;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1093;\n\n&#1083;&#1080;&#1094;, &#1092;&#1080;&#1083;&#1080;&#1072;&#1083;&#1086;&#1074; (&#1087;&#1088;&#1077;&#1076;&#1089;&#1090;&#1072;&#1074;&#1080;&#1090;&#1077;&#1083;&#1100;&#1089;&#1090;&#1074;)</name><place>&#1075;.&#1041;&#1080;&#1096;&#1082;&#1077;&#1082;\n\n&#1086;&#1090; 20 &#1092;&#1077;&#1074;&#1088;&#1072;&#1083;&#1103; 2009 &#1075;&#1086;&#1076;&#1072; N 57</place><revisions>(&#1042; &#1088;&#1077;&#1076;&#1072;&#1082;&#1094;&#1080;&#1080; &#1047;&#1072;&#1082;&#1086;&#1085;&#1086;&#1074; &#1050;&#1056; &#1086;&#1090; 15 &#1080;&#1102;&#1083;&#1103; 2009 &#1075;&#1086;&#1076;&#1072; N 207,\n\n18 &#1076;&#1077;&#1082;&#1072;&#1073;&#1088;&#1103; 2009 &#1075;&#1086;&#1076;&#1072; N 313, 21 &#1076;&#1077;&#1082;&#1072;&#1073;&#1088;&#1103; 2011 &#1075;&#1086;&#1076;&#1072; N 241,\n\n13 &#1072;&#1087;&#1088;&#1077;&#1083;&#1103; 2012 &#1075;&#1086;&#1076;&#1072; N 35, 13 &#1076;&#1077;&#1082;&#1072;&#1073;&#1088;&#1103; 2012 &#1075;&#1086;&#1076;&#1072; N 199)</revisions></description><article id="article_1" number="1" name="&#1057;&#1090;&#1072;&#1090;&#1100;&#1103; 1. &#1054;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1084;&#1099;&#1077; &#1085;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1084; &#1047;&#1072;&#1082;&#1086;&#1085;&#1086;&#1084;" level="article"><item number="1" id="article1_item_1" level="article1_item">&#1053;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1081; &#1047;&#1072;&#1082;&#1086;&#1085; &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1090; &#1086;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1074;&#1086;&#1079;&#1085;&#1080;&#1082;&#1072;</item></article><article id="article_2" number="1" name="&#1057;&#1090;&#1072;&#1090;&#1100;&#1103; 1. &#1054;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1084;&#1099;&#1077; &#1085;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1084; &#1047;&#1072;&#1082;&#1086;&#1085;&#1086;&#1084;" level="article"><item number="1" id="article1_item_1" level="article1_item">&#1053;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1081; &#1047;&#1072;&#1082;&#1086;&#1085; &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1090; &#1086;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1074;&#1086;&#1079;&#1085;&#1080;&#1082;&#1072;</item></article></document>'
        ref.source_document = Document(1)
        ref.source_element = u'#article_1'
        ref.target_document = Document(2)
        ref.target_element = u'#article_2'
        expected_xml = '<document>\n  <description>\n    <name>&#1047;&#1040;&#1050;&#1054;&#1053; &#1050;&#1067;&#1056;&#1043;&#1067;&#1047;&#1057;&#1050;&#1054;&#1049; &#1056;&#1045;&#1057;&#1055;&#1059;&#1041;&#1051;&#1048;&#1050;&#1048;2\n\n&#1054; &#1075;&#1086;&#1089;&#1091;&#1076;&#1072;&#1088;&#1089;&#1090;&#1074;&#1077;&#1085;&#1085;&#1086;&#1081; &#1088;&#1077;&#1075;&#1080;&#1089;&#1090;&#1088;&#1072;&#1094;&#1080;&#1080; &#1102;&#1088;&#1080;&#1076;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1093;\n\n&#1083;&#1080;&#1094;, &#1092;&#1080;&#1083;&#1080;&#1072;&#1083;&#1086;&#1074; (&#1087;&#1088;&#1077;&#1076;&#1089;&#1090;&#1072;&#1074;&#1080;&#1090;&#1077;&#1083;&#1100;&#1089;&#1090;&#1074;)</name>\n    <place>&#1075;.&#1041;&#1080;&#1096;&#1082;&#1077;&#1082;\n\n&#1086;&#1090; 20 &#1092;&#1077;&#1074;&#1088;&#1072;&#1083;&#1103; 2009 &#1075;&#1086;&#1076;&#1072; N 57</place>\n    <revisions>(&#1042; &#1088;&#1077;&#1076;&#1072;&#1082;&#1094;&#1080;&#1080; &#1047;&#1072;&#1082;&#1086;&#1085;&#1086;&#1074; &#1050;&#1056; &#1086;&#1090; 15 &#1080;&#1102;&#1083;&#1103; 2009 &#1075;&#1086;&#1076;&#1072; N 207,\n\n18 &#1076;&#1077;&#1082;&#1072;&#1073;&#1088;&#1103; 2009 &#1075;&#1086;&#1076;&#1072; N 313, 21 &#1076;&#1077;&#1082;&#1072;&#1073;&#1088;&#1103; 2011 &#1075;&#1086;&#1076;&#1072; N 241,\n\n13 &#1072;&#1087;&#1088;&#1077;&#1083;&#1103; 2012 &#1075;&#1086;&#1076;&#1072; N 35, 13 &#1076;&#1077;&#1082;&#1072;&#1073;&#1088;&#1103; 2012 &#1075;&#1086;&#1076;&#1072; N 199)</revisions>\n  </description>\n  <article id="article_1" number="1" name="&#1057;&#1090;&#1072;&#1090;&#1100;&#1103; 1. &#1054;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1084;&#1099;&#1077; &#1085;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1084; &#1047;&#1072;&#1082;&#1086;&#1085;&#1086;&#1084;" level="article">\n    <item number="1" id="article1_item_1" level="article1_item">&#1053;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1081; &#1047;&#1072;&#1082;&#1086;&#1085; &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1090; &#1086;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1074;&#1086;&#1079;&#1085;&#1080;&#1082;&#1072;</item>\n  </article>\n  <article id="article_2" number="1" name="&#1057;&#1090;&#1072;&#1090;&#1100;&#1103; 1. &#1054;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1084;&#1099;&#1077; &#1085;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1084; &#1047;&#1072;&#1082;&#1086;&#1085;&#1086;&#1084;" level="article">\n    <item number="1" id="article1_item_1" level="article1_item">&#1053;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1081; &#1047;&#1072;&#1082;&#1086;&#1085; &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1090; &#1086;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1074;&#1086;&#1079;&#1085;&#1080;&#1082;&#1072;</item>\n    <links>\n      <link reference_doc_id="1" reference_element="article_1"/>\n    </links>\n  </article>\n</document>\n'
        self.assertEqual(expected_xml, update_target_document_content(target_document_content, ref))

    def test_add_link_to_not_existing_article(self):
        ref = Reference()
        target_document_content = u'<document><description><name>&#1047;&#1040;&#1050;&#1054;&#1053; &#1050;&#1067;&#1056;&#1043;&#1067;&#1047;&#1057;&#1050;&#1054;&#1049; &#1056;&#1045;&#1057;&#1055;&#1059;&#1041;&#1051;&#1048;&#1050;&#1048;2\n\n&#1054; &#1075;&#1086;&#1089;&#1091;&#1076;&#1072;&#1088;&#1089;&#1090;&#1074;&#1077;&#1085;&#1085;&#1086;&#1081; &#1088;&#1077;&#1075;&#1080;&#1089;&#1090;&#1088;&#1072;&#1094;&#1080;&#1080; &#1102;&#1088;&#1080;&#1076;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1093;\n\n&#1083;&#1080;&#1094;, &#1092;&#1080;&#1083;&#1080;&#1072;&#1083;&#1086;&#1074; (&#1087;&#1088;&#1077;&#1076;&#1089;&#1090;&#1072;&#1074;&#1080;&#1090;&#1077;&#1083;&#1100;&#1089;&#1090;&#1074;)</name><place>&#1075;.&#1041;&#1080;&#1096;&#1082;&#1077;&#1082;\n\n&#1086;&#1090; 20 &#1092;&#1077;&#1074;&#1088;&#1072;&#1083;&#1103; 2009 &#1075;&#1086;&#1076;&#1072; N 57</place><revisions>(&#1042; &#1088;&#1077;&#1076;&#1072;&#1082;&#1094;&#1080;&#1080; &#1047;&#1072;&#1082;&#1086;&#1085;&#1086;&#1074; &#1050;&#1056; &#1086;&#1090; 15 &#1080;&#1102;&#1083;&#1103; 2009 &#1075;&#1086;&#1076;&#1072; N 207,\n\n18 &#1076;&#1077;&#1082;&#1072;&#1073;&#1088;&#1103; 2009 &#1075;&#1086;&#1076;&#1072; N 313, 21 &#1076;&#1077;&#1082;&#1072;&#1073;&#1088;&#1103; 2011 &#1075;&#1086;&#1076;&#1072; N 241,\n\n13 &#1072;&#1087;&#1088;&#1077;&#1083;&#1103; 2012 &#1075;&#1086;&#1076;&#1072; N 35, 13 &#1076;&#1077;&#1082;&#1072;&#1073;&#1088;&#1103; 2012 &#1075;&#1086;&#1076;&#1072; N 199)</revisions></description><article id="article_1" number="1" name="&#1057;&#1090;&#1072;&#1090;&#1100;&#1103; 1. &#1054;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1084;&#1099;&#1077; &#1085;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1084; &#1047;&#1072;&#1082;&#1086;&#1085;&#1086;&#1084;" level="article"><item number="1" id="article1_item_1" level="article1_item">&#1053;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1081; &#1047;&#1072;&#1082;&#1086;&#1085; &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1090; &#1086;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1074;&#1086;&#1079;&#1085;&#1080;&#1082;&#1072;</item></article><article id="article_2" number="1" name="&#1057;&#1090;&#1072;&#1090;&#1100;&#1103; 1. &#1054;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1084;&#1099;&#1077; &#1085;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1084; &#1047;&#1072;&#1082;&#1086;&#1085;&#1086;&#1084;" level="article"><item number="1" id="article1_item_1" level="article1_item">&#1053;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1081; &#1047;&#1072;&#1082;&#1086;&#1085; &#1088;&#1077;&#1075;&#1091;&#1083;&#1080;&#1088;&#1091;&#1077;&#1090; &#1086;&#1090;&#1085;&#1086;&#1096;&#1077;&#1085;&#1080;&#1103;, &#1074;&#1086;&#1079;&#1085;&#1080;&#1082;&#1072;</item></article></document>'
        ref.source_document = Document(1)
        ref.source_element = u'#article_15414514751145146'
        ref.target_document = Document(2)
        ref.target_element = u'#article_81451451459415'
        with self.assertRaises(Exception):
            update_target_document_content(target_document_content, ref)

    def test_add_link_with_not_expecting_data_format(self):
        ref = Reference()
        target_document_content = ''
        ref.source_document = Document(1)
        ref.source_element = 75
        ref.target_document = Document(2)
        ref.target_element = 46
        with self.assertRaises(BaseException):
             update_target_document_content(target_document_content, ref)
